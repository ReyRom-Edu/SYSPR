**Лекция: Регистры и команды математического сопроцессора в MASM**

### 1. Введение в математический сопроцессор

Математический сопроцессор (FPU — Floating Point Unit) является частью процессора x86, предназначенной для выполнения операций с числами с плавающей запятой. В архитектуре x86 начиная с процессоров Intel 80386 и выше сопроцессор встроен в основной процессор.

MASM (Microsoft Macro Assembler) поддерживает программирование с использованием команд математического сопроцессора, что позволяет работать с вещественными числами эффективно и точно.

### 2. Регистры FPU

Математический сопроцессор содержит стек из 8 80-битных регистров, обозначаемых как ST(0) – ST(7). Эти регистры используются для выполнения арифметических операций. Доступ к ним организован по принципу стека: операции в основном выполняются с вершиной стека (ST(0)).

Каждый регистр может хранить число в формате с плавающей запятой:

- Числа одинарной, двойной и расширенной точности.
- Целые числа, приведённые к формату FPU.

Структура регистра FPU:

- **Знак (1 бит)**
- **Порядок (15 бит)**
- **Мантисса (64 бита)**

### 3. Основные команды математического сопроцессора

MASM поддерживает множество команд работы с FPU, которые можно разделить на несколько групп:

#### 3.1. Загрузка и сохранение данных

- `FLD src` — загрузка числа в вершину стека FPU.
- `FST dest` — сохранение числа из ST(0) в память.
- `FSTP dest` — сохранение числа из ST(0) в память с извлечением из стека.

Пример:

```assembly
FLD dword ptr [val]   ; загрузка числа одинарной точности в ST(0)
FSTP qword ptr [res]  ; сохранение числа двойной точности и извлечение из стека
```

#### 3.2. Арифметические операции

- `FADD ST(i), ST(j)` — сложение ST(i) + ST(j).
- `FSUB ST(i), ST(j)` — вычитание ST(i) - ST(j).
- `FMUL ST(i), ST(j)` — умножение ST(i) \* ST(j).
- `FDIV ST(i), ST(j)` — деление ST(i) / ST(j).
- `FABS` — замена ST(0) на его модуль.
- `FCHS` — смена знака ST(0).

Пример:

```assembly
FLD dword ptr [a]   ; Загрузить a в ST(0)
FLD dword ptr [b]   ; Загрузить b в ST(0), a сдвигается в ST(1)
FADD                ; ST(0) = ST(0) + ST(1)
FSTP dword ptr [c]  ; Сохранить результат в c
```

#### 3.3. Сравнение чисел

- `FCOM ST(i)` — сравнивает значение в ST(0) с ST(i), выставляя соответствующие флаги.
- `FCOMP ST(i)` — аналогично `FCOM`, но дополнительно извлекает ST(0) из стека.
- `FICOM mem` — сравнивает ST(0) с целым значением из памяти.
- `FICOMP mem` — аналогично `FICOM`, но извлекает ST(0).
- `FTST` — сравнивает ST(0) с нулём.
- `FXAM` — анализирует тип значения в ST(0).

При выполнении команд сравнения в регистре статусного слова FPU (FPU Status Word) изменяются флаги C0, C2 и C3:

- **C0** = 1, если ST(0) > операнд
- **C3** = 1, если ST(0) = операнд
- **C0** и **C3** = 1, если ST(0) < операнд
- **C2** = 1, если операнд является NaN (Not a Number)

После выполнения сравнения флаги необходимо загрузить в регистр флагов процессора для последующего анализа, используя:

- `FSTSW AX` — сохраняет статусное слово FPU в AX.
- `SAHF` — копирует младшие 8 бит AX в флаговый регистр процессора.

Пример:

```assembly
FLD dword ptr [x]    ; Загрузка x в ST(0)
FLD dword ptr [y]    ; Загрузка y в ST(0), x -> ST(1)
FCOM                 ; Сравнение ST(0) и ST(1)
FSTSW AX             ; Запись результата сравнения в AX
SAHF                 ; Загрузка флагов в регистр процессора
JBE less_or_equal    ; Переход, если x <= y
```

#### 3.4. Тригонометрические и другие функции

- `FSIN` — вычисление синуса.
- `FCOS` — вычисление косинуса.
- `FPTAN` — вычисление тангенса.
- `FSQRT` — вычисление квадратного корня.
- `FYL2X` — вычисление y \* log2(x).

Пример:

```assembly
FLD dword ptr [angle]  ; Загрузить угол
FSIN                    ; Вычислить sin(angle)
FSTP dword ptr [result] ; Сохранить результат
```

### 4. Управление стеком FPU

Поскольку FPU работает как стек, важно управлять его состоянием:

- `FINIT` — инициализация FPU, сброс всех регистров.
- `FFREE ST(i)` — пометить регистр ST(i) как свободный.
- `FSTCW mem` — сохранить управляющее слово FPU.
- `FLDCW mem` — загрузить управляющее слово FPU.

### 5. Пример программы на MASM с FPU

```assembly
.DATA
    a REAL4 3.14
    b REAL4 2.0
    res REAL4 ?

.CODE
    FLD a      ; Загрузить a в ST(0)
    FLD b      ; Загрузить b в ST(0), a -> ST(1)
    FMUL       ; ST(0) = ST(0) * ST(1)
    FSTP res   ; Сохранить результат в res
    FINIT      ; Инициализация FPU
END
```

### 6. Заключение

Математический сопроцессор позволяет выполнять сложные вычисления с высокой точностью. Понимание его регистровой структуры и команд в MASM даёт возможность эффективно использовать FPU в программах на ассемблере.

Для лучшего усвоения материала рекомендуется реализовать несколько простых программ с использованием FPU, проверить работу команд `FLD`, `FSTP`, `FADD`, `FMUL` и сравнение чисел с `FCOM`. Это поможет закрепить теоретические знания на практике.

